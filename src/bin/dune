(library
 (name cli)
 (instrumentation
  (backend bisect_ppx))
 (libraries
  simple-utils
  cmdliner
  ligo
  ligo_compile
  build
  repl
  install
  cli_helpers
  ligo_api)
 (modules cli version))

(library
 (name cli_helpers)
 (instrumentation
  (backend bisect_ppx))
 (libraries simple-utils lwt lwt.unix)
 (modules cli_helpers))

(library
 (name repl)
 (instrumentation
  (backend bisect_ppx))
 (libraries simple-utils cmdliner ligo build linenoise)
 (modules repl))

(library
 (name install)
 (instrumentation
  (backend bisect_ppx))
 (libraries cli_helpers simple-utils lwt lwt.unix)
 (modules install))

(rule
 (targets version.ml)
 (action
  (with-stdout-to
   version.ml
   (run "sh" "-c" "printf 'let version = \"%s\"' \"${LIGO_VERSION}\""))))

; build static executable with --profile static

(env
 (static
  (flags
   (:standard -ccopt -static -cclib "-lgmp"))))

(executable
 (name runligo)
 (public_name ligo)
 (instrumentation
 (backend bisect_ppx))
 (libraries simple-utils cmdliner ligo cli)
 (modes js native)
 (modules runligo)
 (package ligo))

(copy_files
  hacl-js/{runtime-generated.js,helper.js,random.js,evercrypt.js})


(executable
 (name main)
 ; (libraries zarith_stubs_js ctypes_stubs_js ligo_api)
 (flags -g)
 (js_of_ocaml
  (javascript_files threads.js bls12-runtime.js blst.js runtime-generated.js helper.js random.js evercrypt.js)
  (flags
    "--debuginfo" "+bls12-381-unix/bls-runtime-helpers.js" "+bls12-381-unix/blst_bindings_stubs.js"))
 (libraries core zarith_stubs_js integers_stubs_js ctypes_stubs_js ligo_api_compile)
 (modes js)
 (modules main))
